// ==============================
// üåç ESTACI√ìN TIERRA - 3 LEDs + LCD + AMENAZA
// ==============================

#include <SoftwareSerial.h>
#include <LiquidCrystal.h>

SoftwareSerial satSerial(10, 11);

// PINES LCD
#define LCD_RS 3
#define LCD_E  4
#define LCD_D4 5
#define LCD_D5 6
#define LCD_D6 7
#define LCD_D7 8  // Pin 8 = LCD D7

LiquidCrystal lcd(LCD_RS, LCD_E, LCD_D4, LCD_D5, LCD_D6, LCD_D7);

// PINES LEDs
#define LED_RX        12  // RX datos
#define LED_TIMEOUT   13  // Timeout
#define LED_ERROR      9  // MISMO LED para DHT + ULTRA

unsigned long ultimoMensaje = 0;
const unsigned long TIMEOUT_COMUNICACION = 15000;

bool alertaDHTActiva     = false;
bool alertaUltraActiva   = false;
bool alertaTimeoutActiva = false;
bool amenazaActiva       = false;

void setup() {
  pinMode(LED_RX, OUTPUT);
  pinMode(LED_TIMEOUT, OUTPUT);
  pinMode(LED_ERROR, OUTPUT);   // LED √∫nico de error

  digitalWrite(LED_RX, LOW);
  digitalWrite(LED_TIMEOUT, LOW);
  digitalWrite(LED_ERROR, LOW);

  Serial.begin(9600);     // PC/Python
  satSerial.begin(9600);  // Sat√©lite

  lcd.begin(16, 2);
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("ESTACION TIERRA");
  lcd.setCursor(0, 1);
  lcd.print("Esperando sat...");

  Serial.println("BRIDGE: Estaci√≥n de Tierra lista");
  ultimoMensaje = millis();
}

void loop() {
  // 1) Datos desde SAT√âLITE
  if (satSerial.available()) {
    String data = satSerial.readStringUntil('\n');
    data.trim();
    if (!data.length()) return;

    ultimoMensaje = millis();
    digitalWrite(LED_RX, HIGH);
    delay(20);
    digitalWrite(LED_RX, LOW);

    // Si hab√≠a timeout, se recupera
    if (alertaTimeoutActiva) {
      alertaTimeoutActiva = false;
      digitalWrite(LED_TIMEOUT, LOW);
      Serial.println("BRIDGE: ‚úÖ Sat√©lite OK");
      lcd.clear();
      lcd.setCursor(0, 0); lcd.print("SAT RECONECTADO");
      delay(1000);
      lcd.clear();
      lcd.setCursor(0, 0); lcd.print("ESTACION TIERRA");
    }

    // AMENAZA ON/OFF
    if (data.indexOf("5:AMENAZA_ON") != -1) {
      if (!amenazaActiva) {
        amenazaActiva = true;
        lcd.clear();
        lcd.setCursor(0, 0); lcd.print("*** AMENAZA ***");
        lcd.setCursor(0, 1); lcd.print("Objeto <=50cm");
        Serial.println("BRIDGE: ‚ö†Ô∏è AMENAZA");
      }
    }
    else if (data.indexOf("5:AMENAZA_OFF") != -1) {
      if (amenazaActiva) {
        amenazaActiva = false;
        lcd.clear();
        lcd.setCursor(0, 0); lcd.print("AREA SEGURA");
        lcd.setCursor(0, 1); lcd.print("Dist >50cm OK");
        Serial.println("BRIDGE: ‚úÖ Seguro");
      }
    }

    // FALLO DHT (mensaje tipo "3:")
    else if (data.startsWith("3:")) {
      if (!alertaDHTActiva) {
        alertaDHTActiva = true;
        Serial.println("BRIDGE: ‚ö†Ô∏è DHT fallo");
      }
      Serial.println(data);
    }

    // FALLO ULTRASONIDO (mensaje tipo "6:")
    else if (data.startsWith("6:")) {
      if (!alertaUltraActiva) {
        alertaUltraActiva = true;
        Serial.println("BRIDGE: ‚ö†Ô∏è Ultra fallo");
      }
      Serial.println(data);
    }

    // Mensajes normales
    else {
      // Si hab√≠a fallos y ahora llegan datos normales, resetea banderas
      if (alertaDHTActiva) {
        alertaDHTActiva = false;
        Serial.println("BRIDGE: ‚úÖ DHT OK");
      }
      if (alertaUltraActiva) {
        alertaUltraActiva = false;
        Serial.println("BRIDGE: ‚úÖ Ultra OK");
      }
      Serial.println(data);
    }

    // LED ERROR en funci√≥n de cualquier fallo de sensor
    if (alertaDHTActiva || alertaUltraActiva) {
      digitalWrite(LED_ERROR, HIGH);   // Encendido si cualquier fallo
    } else {
      digitalWrite(LED_ERROR, LOW);    // Apagado si todo OK
    }
  }

  // 2) TIMEOUT ‚Üí LED 13 y mensaje LCD
  if (!alertaTimeoutActiva && millis() - ultimoMensaje > TIMEOUT_COMUNICACION) {
    alertaTimeoutActiva = true;
    digitalWrite(LED_TIMEOUT, HIGH);
    Serial.println("BRIDGE: ‚ö†Ô∏è Sin sat√©lite");
    lcd.clear();
    lcd.setCursor(0, 0); lcd.print("SATELITE PERDIDO");
  }

  // 3) COMANDOS PC ‚Üí SAT√âLITE
  if (Serial.available()) {
    String cmd = Serial.readStringUntil('\n');
    cmd.trim();
    if (cmd.length() > 0) {
      satSerial.println(cmd);
    }
  }
}

// ==============================
// üåç ESTACI√ìN TIERRA - ANTI SPAM
// Alertas √∫nicas + timeout largo
// ==============================

#include <SoftwareSerial.h>

SoftwareSerial satSerial(10, 11); // RX, TX hacia sat√©lite

const int ledRx = 12;     // LED parpadea al recibir datos
const int ledAlerta = 13; // LED alerta general

// ---------- TIMING ----------
unsigned long ultimoMensaje = 0;
const unsigned long TIMEOUT_COMUNICACION = 15000; // ‚è±Ô∏è 15 s (ANTES 5s)

// ---------- ESTADOS DE ALERTA ----------
bool alertaDHTActiva = false;
bool alertaUltraActiva = false;
bool alertaTimeoutActiva = false;

void setup() {
  pinMode(ledRx, OUTPUT);
  pinMode(ledAlerta, OUTPUT);

  Serial.begin(9600);     // Comunicaci√≥n con Python
  satSerial.begin(9600);  // Comunicaci√≥n con sat√©lite

  Serial.println("Estaci√≥n de Tierra lista");
  ultimoMensaje = millis();
}

void loop() {

  // =================================
  // 1Ô∏è‚É£ RECEPCI√ìN DESDE EL SAT√âLITE
  // =================================
  if (satSerial.available()) {
    String data = satSerial.readStringUntil('\n');
    data.trim();

    ultimoMensaje = millis();

    // LED RX
    digitalWrite(ledRx, HIGH);
    delay(30);
    digitalWrite(ledRx, LOW);

    // ---- RECUPERACI√ìN DE TIMEOUT ----
    if (alertaTimeoutActiva) {
      alertaTimeoutActiva = false;
      Serial.println("‚úÖ Comunicaci√≥n con sat√©lite recuperada");
    }

    // ---------- FALLO DHT ----------
    if (data.startsWith("3:")) {
      if (!alertaDHTActiva) {
        alertaDHTActiva = true;
        Serial.println("‚ö†Ô∏è Fallo sensor DHT");
      }
    }

    // ---------- FALLO ULTRASONIDOS ----------
    else if (data.startsWith("6:")) {
      if (!alertaUltraActiva) {
        alertaUltraActiva = true;
        Serial.println("‚ö†Ô∏è Fallo sensor ultrasonido");
      }
    }

    // ---------- DATOS NORMALES ----------
    else {
      // Recuperaci√≥n DHT
      if (alertaDHTActiva) {
        alertaDHTActiva = false;
        Serial.println("‚úÖ Sensor DHT recuperado");
      }

      // Recuperaci√≥n ultrasonidos
      if (alertaUltraActiva) {
        alertaUltraActiva = false;
        Serial.println("‚úÖ Sensor ultrasonido recuperado");
      }

      Serial.println(data); // reenviar datos a Python
    }
  }

  // =================================
  // 2Ô∏è‚É£ TIMEOUT DE COMUNICACI√ìN
  // =================================
  if (!alertaTimeoutActiva &&
      millis() - ultimoMensaje > TIMEOUT_COMUNICACION) {

    alertaTimeoutActiva = true;
    Serial.println("‚ö†Ô∏è Sin comunicaci√≥n con el sat√©lite");
  }

  // =================================
  // 3Ô∏è‚É£ LED DE ALERTA GLOBAL
  // =================================
  if (alertaDHTActiva || alertaUltraActiva || alertaTimeoutActiva) {
    digitalWrite(ledAlerta, HIGH);
  } else {
    digitalWrite(ledAlerta, LOW);
  }

  // =================================
  // 4Ô∏è‚É£ COMANDOS DESDE PYTHON ‚Üí SAT√âLITE
  // =================================
  if (Serial.available()) {
    String cmd = Serial.readStringUntil('\n');
    cmd.trim();
    if (cmd.length() > 0) {
      satSerial.println(cmd);
    }
  }
}

